###
#Основные параметры MTA-сервера
###
mail_name = R7-MailServer

myhostname = {{ MAIL_FQDN_FULL_NAME }}
myorigin = $myhostname
mydomain = {{ MAIL_HOST_NAME }}

smtpd_banner = $myhostname ESMTP $mail_name (AO R7, r7-office.ru)

###
#Network
###
inet_interfaces = all
inet_protocols = all
#mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
#mydestination = localhost.$mydomain, localhost
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128

###
#Other
###
biff = no
append_dot_mydomain = no
readme_directory = /usr/share/doc/postfix
compatibility_level = 3.6

###
# SSL/TLS Параметры входящей почты
###
smtpd_use_tls = yes
smtpd_tls_cert_file = {{ MAIL_MTA_CERT_CRT_FILE }}
smtpd_tls_key_file = {{ MAIL_MTA_CERT_KEY_FILE }}
#smtpd_tls_security_level = may
smtpd_tls_auth_only = no
smtpd_tls_received_header = yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_session_cache_timeout = 3600s
smtpd_tls_loglevel = 1

###
# SSL/TLS Параметры исходящей почты
###
#smtp_tls_policy_maps = proxy:pgsql:/etc/postfix/psql/virtual_transport/psql-smtp_tls_policy_maps.cf
smtp_tls_CApath=/etc/ssl/certs
smtp_tls_security_level=may
#smtp_tls_security_level = encrypt
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
smtp_tls_session_cache_timeout = 3600s
smtp_tls_loglevel = 1
#Клиентский сертификат для MTA
smtp_tls_cert_file = {{ MAIL_MTA_CERT_CRT_FILE }}
smtp_tls_key_file = {{ MAIL_MTA_CERT_KEY_FILE }}

###
# SSL/TLS Параметры локальной доставки
###
#lmtp_tls_policy_maps = proxy:pgsql:/etc/postfix/psql/virtual_transport/psql-lmtp_tls_policy_maps.cf
lmtp_tls_security_level = may
lmtp_tls_session_cache_database = btree:${data_directory}/lmtp_scache
lmtp_tls_session_cache_timeout = 3600s
lmtp_tls_loglevel = 4
#Клиентский сертификат для MDA
lmtp_tls_cert_file = {{ MAIL_MTA_CERT_CRT_FILE }}
lmtp_tls_key_file = {{ MAIL_MTA_CERT_KEY_FILE }}


# SMTP-AUTH (исходящая)
#smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
#smtp_sasl_auth_enable = yes

# SMTPD-AUTH (входящая): настройки SASL-авторизации в Dovecot по TCP
smtpd_sasl_type = dovecot
smtpd_sasl_path = inet:{{ MAIL_MTA_SASL_HOST }}:{{ MAIL_MTA_SASL_PORT }}
#smtpd_sasl_path = pgsql:/etc/postfix/psql/psql-smtpd_sasl_path.cf
smtpd_sasl_auth_enable = yes
#smtpd_sasl_auth_enable = no
smtpd_sasl_security_options = noanonymous
#smtpd_sasl_local_domain = $myhostname
#broken_sasl_auth_clients = yes
broken_sasl_auth_clients = no

###
#Canonical Name
###
remote_header_rewrite_domain = domain.invalid
sender_canonical_maps = proxy:pgsql:/etc/postfix/psql/canonical/psql-sender_canonical_maps.cf
recipient_canonical_maps = proxy:pgsql:/etc/postfix/psql/canonical/psql-recipient_canonical_maps.cf

###
#Aliases
###
virtual_alias_maps = proxy:pgsql:/etc/postfix/psql/aliases/psql-virtual_alias_maps.cf

###
#Relocated
###
relocated_maps = proxy:pgsql:/etc/postfix/psql/notify/psql-relocated_maps.cf

###
#smtp relay
###
relayhost = 

#Локальные ящики
# Отключаем локальную доставку
local_recipient_maps =
mydestination =
local_transport = error:no local delivery
inet_interfaces = all
home_mailbox =
mailbox_command =
virtual_mailbox_base = 

###
#Настройка LMTP
###
#lmtp_destination_concurrency_limit = 5
#lmtp_destination_recipient_limit = 100

###
#Proxy_map
###
proxy_read_maps =
    proxy:pgsql:/etc/postfix/psql/virtual_email/psql-virtual_mailbox_domains.cf,
    proxy:pgsql:/etc/postfix/psql/virtual_email/psql-virtual_mailbox_maps.cf,
    proxy:pgsql:/etc/postfix/psql/virtual_transport/psql-virtual_transport.cf,
    proxy:pgsql:/etc/postfix/psql/virtual_transport/psql-smtp_tls_policy_maps.cf,
    proxy:pgsql:/etc/postfix/psql/virtual_transport/psql-lmtp_tls_policy_maps.cf,
    proxy:pgsql:/etc/postfix/psql/canonical/psql-sender_canonical_maps.cf,
    proxy:pgsql:/etc/postfix/psql/canonical/psql-recipient_canonical_maps.cf,
    proxy:pgsql:/etc/postfix/psql/aliases/psql-virtual_alias_maps.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_client.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_helo.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_sender.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_recipient.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_helo_access_scope_helo.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_helo_access_scope_sender.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_helo_access_scope_recipient.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_sender_access_scope_sender.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_sender_access_scope_recipient.cf,
    proxy:pgsql:/etc/postfix/psql/filters/psql-r7_recipient_access_scope_recipient.cf,
    proxy:pgsql:/etc/postfix/psql/notify/psql-relocated_maps.cf


###
#Транспортные настройки
###
default_transport = smtp:
virtual_mailbox_domains = proxy:pgsql:/etc/postfix/psql/virtual_email/psql-virtual_mailbox_domains.cf
virtual_mailbox_maps = proxy:pgsql:/etc/postfix/psql/virtual_email/psql-virtual_mailbox_maps.cf
transport_maps = proxy:pgsql:/etc/postfix/psql/virtual_transport/psql-virtual_transport.cf

#virtual_transport = lmtp:127.0.0.1:24
#virtual_transport_maps = pgsql:/etc/postfix/psql/psql-virtual_transport.cf
#fallback_transport = pgsql:/etc/postfix/psql/psql-fallback_transport.cf

###
#Правила фильтрации
###
#smtpd_relay_before_recipient_restrictions = no
#Для корректной работы access листов
parent_domain_matches_subdomains = 
#Для обработки списков на каждом уровне фильтрации
smtpd_delay_reject = no
#Р7-Классы проверок
smtpd_restriction_classes = 
    r7_client_access_scope_client, r7_client_access_scope_helo, r7_client_access_scope_sender, r7_client_access_scope_recipient, 
    r7_helo_access_scope_helo, r7_helo_access_scope_sender, r7_helo_access_scope_recipient, 
    r7_sender_access_scope_sender, r7_sender_access_scope_recipient,
    r7_recipient_access_scope_recipient 
    r7_etrn_access,
    r7_data_access,
    r7_end_of_data_access

### Описание Р7-Классов проверок
r7_client_access_scope_client =
    check_client_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_client.cf
r7_client_access_scope_helo =
    check_client_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_helo.cf
r7_client_access_scope_sender =
    check_client_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_sender.cf
r7_client_access_scope_recipient =
    check_client_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_client_access_scope_recipient.cf

r7_helo_access_scope_helo =
    check_helo_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_helo_access_scope_helo.cf
r7_helo_access_scope_sender =
    check_helo_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_helo_access_scope_sender.cf
r7_helo_access_scope_recipient =
    check_helo_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_helo_access_scope_recipient.cf

r7_etrn_access = permit

r7_sender_access_scope_sender = 
    check_sender_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_sender_access_scope_sender.cf
r7_sender_access_scope_recipient = 
    check_sender_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_sender_access_scope_recipient.cf

r7_recipient_access_scope_recipient = 
    check_recipient_access proxy:pgsql:/etc/postfix/psql/filters/psql-r7_recipient_access_scope_recipient.cf,
    check_policy_service inet:{{ MAIL_MTA_FILTER_HOST }}:{{ MAIL_MTA_FILTER_PORT }}

r7_data_access = permit

r7_end_of_data_access = permit

### Рестрикшены
smtpd_client_restrictions = 
    permit_mynetworks,
    r7_client_access_scope_client,
    permit

smtpd_helo_restrictions = 
    permit_mynetworks,
    r7_client_access_scope_helo,
    r7_helo_access_scope_helo,
    permit

smtpd_sender_restrictions = 
    permit_mynetworks,
    r7_client_access_scope_sender,
    r7_helo_access_scope_sender,
    r7_sender_access_scope_sender,
    permit

smtpd_recipient_restrictions =
    permit_mynetworks,
    r7_client_access_scope_recipient,
    r7_helo_access_scope_recipient,
    r7_sender_access_scope_recipient,
    r7_recipient_access_scope_recipient,
    permit_sasl_authenticated,
    reject_unauth_destination

smtpd_relay_restrictions = 
    permit_mynetworks,
    permit_sasl_authenticated,
    defer_unauth_destination

#smtpd_milters = inet:localhost:11332
#non_smtpd_milters = $smtpd_milters
#milter_protocol = 6
#milter_default_action = quarantine

recipient_delimiter = +

#Logging
syslog_name = postfix
maillog_file_prefixes = /
maillog_file = /var/log/r7-office/mtaserver/postfix.log
maillog_file_compressor = gzip
maillog_file_rotate_suffix = %H:%M:%S-%d.%m.%Y
debug_peer_level = 5

#Ограничение кол-ва соединений на одного клиента smtpd_client_message_rate_limit(count)/anvil_rate_time_unit(ms)
anvil_rate_time_unit = 300
smtpd_client_message_rate_limit = 1000
smtpd_client_new_tls_session_rate_limit=1000

default_destination_recipient_limit=100

#Максимальное количество получателей по умолчанию для доставки сообщения.
lmtp_destination_recipient_limit = 100
smtp_destination_recipient_limit = 100

lmtp_destination_concurrency_limit = 5

#Верхний предел по умолчанию для каждого транспорта на количество получателей в памяти.
lmtp_recipient_limit=20000
smtp_recipient_limit=20000

message_size_limit = 31457280

qmgr_message_active_limit=20000
qmgr_message_recipient_limit=20000

maximal_backoff_time=4000s
minimal_backoff_time=300s
maximal_queue_lifetime=5d


#Ограничение на количество хопов
hopcount_limit=10

###
#BOUNCED
###
bounce_template_file = /etc/postfix/bounce_template
html_directory = /usr/share/doc/postfix/html
smtpd_client_message_rate_limit = 1000
mailbox_size_limit = 52428800
smtpd_client_recipient_rate_limit = 500
